name: C++ CI - Lab2 Hex

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc-14 g++-14
        sudo ln -sf /usr/bin/gcc-14 /usr/bin/cc
        sudo ln -sf /usr/bin/g++-14 /usr/bin/c++

    # –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ GoogleTest —á–µ—Ä–µ–∑ FetchContent
    - name: CMake configure (pass 1) ‚Äî download GTest
      run: |
        cmake -G Ninja -S Lab2_Var2 -B Lab2_Var2/build \
          -DCMAKE_C_COMPILER=/usr/bin/gcc-14 \
          -DCMAKE_CXX_COMPILER=/usr/bin/g++-14 \
          -DCMAKE_BUILD_TYPE=Release || true

    # –í—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥ ‚Äî –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º GTest
    - name: Reconfigure project (pass 2) ‚Äî now with GTest available
      run: |
        cmake --fresh -G Ninja -S Lab2_Var2 -B Lab2_Var2/build \
          -DCMAKE_C_COMPILER=/usr/bin/gcc-14 \
          -DCMAKE_CXX_COMPILER=/usr/bin/g++-14 \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build all targets
      run: cmake --build Lab2_Var2/build

    - name: Verify test binary and run
      run: |
        cd Lab2_Var2/build
        echo "üìÅ Build directory contents:"
        ls -la

        TEST_BIN=$(find . -type f -executable -name "*Tests" | head -n 1)
        echo "üîç Found test binary: ${TEST_BIN:-<none>}"
        if [ -z "$TEST_BIN" ]; then
          echo "‚ùå Test binary not found"
          echo "üîé Available files in build folder:"
          find . -maxdepth 2 -type f
          echo "‚ö†Ô∏è Checking for configuration errors..."
          cat CMakeFiles/CMakeOutput.log 2>/dev/null || true
          cat CMakeFiles/CMakeError.log 2>/dev/null || true
          exit 1
        fi

        chmod +x "$TEST_BIN"
        echo "üöÄ Running tests..."
        "$TEST_BIN" --gtest_output=xml:test-results.xml || true

        echo "üìÑ Generated test-results.xml:"
        ls -l test-results.xml || echo "‚ö†Ô∏è No XML generated!"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gtest-results
        path: Lab2_Var2/build/test-results.xml

    - name: Publish test summary
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: GTest Results
        path: Lab2_Var2/build/test-results.xml
        reporter: jest-junit
